<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OASIS 象限別 Ken Burns ビューア</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f6f7fb;
      --panel: #ffffff;
      --panel-2: #f0f2f7;
      --text: #1c1f26;
      --muted: #5b6475;
      --accent: #2f7bff;
      --accent-2: #1f9d5a;
      --danger: #d84a4a;
      --border: #d7dbe6;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, #ffffff, var(--bg));
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 16px 40px;
    }

    .container {
      width: min(980px, 100%);
      display: grid;
      gap: 16px;
    }

    body.presentation-mode {
      align-items: center;
      padding-top: 0;
      padding-bottom: 0;
    }

    body.presentation-mode .container {
      min-height: 100vh;
      align-content: center;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 4px 0;
      letter-spacing: 0.02em;
    }

    .lead {
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.5;
      margin: 0;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 24px rgba(22, 28, 45, 0.08);
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .controls-header {
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .controls-title h1 {
      margin-bottom: 4px;
    }

    .controls-title .lead {
      margin: 0;
    }

    .controls-body {
      display: grid;
      gap: 12px;
    }

    .controls.collapsed .controls-body {
      display: none;
    }

    .controls.collapsed .controls-title .lead {
      display: none;
    }

    .controls.collapsed {
      padding: 10px 12px;
    }

    .controls.collapsed .controls-title h1 {
      font-size: 1.05rem;
      margin: 0;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    label {
      font-size: 0.9rem;
      color: var(--muted);
    }

    select, button, input[type="number"] {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.95rem;
    }

    select {
      min-width: 180px;
    }

    button {
      cursor: pointer;
      transition: transform 0.12s ease, background 0.2s ease, border-color 0.2s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      border-color: var(--accent);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .primary {
      background: linear-gradient(135deg, #2f7bff, #5aa4ff);
      border: none;
      color: #fff;
    }

    .ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .danger {
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    .viewer {
      position: relative;
      width: 100%;
      height: min(56vh, 520px);
      background: #eef1f6;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .fixation {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: #1c1f26;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
      opacity: 0;
      transition: opacity 120ms ease;
      z-index: 2;
      pointer-events: none;
    }

    .fixation.active {
      opacity: 1;
    }

    .slide {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0;
      transform: scale(1);
      transition: opacity var(--fade-ms) ease;
      animation: kenburns var(--duration-ms) linear forwards;
      will-change: transform, opacity;
    }

    .slide.active {
      opacity: 1;
    }

    .viewer.paused .slide {
      animation-play-state: paused;
    }

    @keyframes kenburns {
      from {
        transform: translate(var(--from-x), var(--from-y)) scale(var(--from-scale));
      }
      to {
        transform: translate(var(--to-x), var(--to-y)) scale(var(--to-scale));
      }
    }

    .status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
      font-size: 0.92rem;
      color: var(--muted);
    }

    .status strong {
      color: var(--text);
      display: block;
      font-size: 1rem;
      margin-top: 4px;
    }

    .status-panel .controls-header {
      align-items: center;
    }

    .status-panel .status-body {
      display: block;
    }

    .status-panel.collapsed .status-body {
      display: none;
    }

    .status-panel.collapsed {
      padding: 10px 12px;
    }

    .note {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 4px 0 0;
    }

    .helper-link {
      margin-top: 8px;
      font-size: 0.9rem;
    }

    .helper-link a {
      color: #2457d6;
      text-decoration: none;
      border-bottom: 1px solid transparent;
    }

    .helper-link a:hover {
      border-bottom-color: #2457d6;
    }


    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #2457d6;
      border: 1px solid #d7def7;
      font-size: 0.8rem;
    }

    .log-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(16, 20, 30, 0.56);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .modal-overlay.open {
      display: flex;
    }

    body.presentation-mode .controls,
    body.presentation-mode .status-panel {
      display: none;
    }

    .modal-card {
      width: min(960px, 96vw);
      height: min(780px, 92vh);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.18);
      display: grid;
      grid-template-rows: auto 1fr auto;
      overflow: hidden;
    }

    .modal-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 0.95rem;
      color: var(--muted);
    }

    .modal-frame {
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
    }

    .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      background: #fafbfe;
    }

    @media (max-width: 720px) {
      .viewer { height: 52vh; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel controls" id="controlsPanel">
      <div class="row controls-header">
        <div class="controls-title">
          <h1>OASIS 象限別 Ken Burns ビューア</h1>
          <p class="lead">
            象限ごとに画像を1枚目から10枚目まで、Ken Burns 効果で連続表示します。<br>
            1枚あたり5秒、切替クロスフェード0.5秒＋注視点0.75秒（変更可）。
          </p>
          <p class="helper-link">
            実験協力者情報入力フォーム:
            <a href="https://forms.gle/CkyKkTWB5gF26Q3x9" target="_blank" rel="noopener noreferrer">https://forms.gle/CkyKkTWB5gF26Q3x9</a>
          </p>
        </div>
        <button class="ghost" id="toggleControlsBtn" type="button">閉じる</button>
      </div>

      <div class="controls-body">
      <div class="row">
        <label for="quadrant">ブロック選択</label>
        <select id="quadrant">
          <option value="Block 1">Block 1</option>
          <option value="Block 2">Block 2</option>
          <option value="Block 3">Block 3</option>
          <option value="Block 4">Block 4</option>
          <option value="Block 5">Block 5</option>
          <option value="Block 6">Block 6</option>
          <option value="Block 7">Block 7</option>
          <option value="Block 8">Block 8</option>
        </select>
        <span class="badge" id="badge">10 images</span>
      </div>

      <div class="row">
        <label for="participantIdInput">Participant ID</label>
        <input id="participantIdInput" type="text" value="P01" />
        <label for="seedInput">Seed</label>
        <input id="seedInput" type="number" step="1" placeholder="auto" />
        <label for="excludeUsedToggle">Reuse回避</label>
        <input id="excludeUsedToggle" type="checkbox" checked />
      </div>

      <div class="row">
        <button class="primary" id="practiceBtn">練習を実行</button>
        <button class="primary" id="sessionBtn">本試行を開始</button>
        <button class="ghost" id="startBtn">再開</button>
        <button class="ghost" id="pauseBtn" disabled>一時停止</button>
        <button class="ghost" id="testSoundBtn">音量テスト</button>
        <button class="danger" id="resetBtn">リセット</button>
        <button class="ghost" id="downloadLogBtn">ログCSV</button>
        <button class="ghost" id="downloadAllocBtn">割付けCSV</button>
        <button class="ghost" id="clearLogBtn">ログ消去</button>
      </div>

      <div class="row">
        <label>表示(ms)</label>
        <input id="durationInput" type="number" min="1000" step="250" value="5000" />
        <label>クロスフェード(ms)</label>
        <input id="fadeInput" type="number" min="0" step="50" value="500" />
        <label>注視点(ms)</label>
        <input id="isiInput" type="number" min="0" step="50" value="750" />
      </div>
      <p class="note">※ 数値変更は次の画像から反映されます。</p>
      </div>
    </div>

    <div class="panel">
      <div class="viewer" id="viewer">
        <div class="slide" id="slideA"></div>
        <div class="slide" id="slideB"></div>
        <div class="fixation" id="fixation">+</div>
      </div>
    </div>

    <div class="panel status-panel" id="statusPanel">
      <div class="row controls-header">
        <strong>進行状況</strong>
        <button class="ghost" id="toggleStatusBtn" type="button">閉じる</button>
      </div>
      <div class="status-body">
        <div class="status">
          <div>
            Block
            <strong id="statusBlock">-</strong>
          </div>
          <div>
            象限
            <strong id="statusQuadrant">HVHA</strong>
          </div>
          <div>
            進行
            <strong id="statusProgress">0 / 10</strong>
          </div>
          <div>
            ファイル
            <strong id="statusFile">-</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="ratingModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="ratingModalTitle">
      <div class="modal-header" id="ratingModalTitle">評価を入力してください / Please complete the rating</div>
      <iframe
        class="modal-frame"
        id="ratingFrame"
        src=""
        title="Affective Slider"
      ></iframe>
      <div class="modal-footer">
        <button class="primary" id="ratingDoneBtn" type="button">評定後に再開 / Resume</button>
      </div>
    </div>
  </div>

  <script>
    const basePath = "../oasis_top80/";
    const practiceBasePath = "../oasis_test_img/";
    const NOTIFY_AUDIO = "pc980_startup_like_0_25s.m4a";
    const RATING_PAGE_URL = "../affective_slider_exp/affective_slider_oasis_exp.html";
    const RATING_PAGE_VERSION = "20260213-2";
    const NOTIF_BASE_MS = 2500;
    const NOTIF_JITTER_RANGE_MS = 500;
    const UI_LABELS = ["Condition A", "Condition B"];
    const PRACTICE_IMAGE_POOL = [
      "Alcohol 1.jpg",
      "Bed 1.jpg",
      "Camping 6.jpg",
      "Clean 1.jpg",
      "Crow 2.jpg",
      "Doctor 1.jpg",
      "Fence 1.jpg",
      "Fire 7.jpg",
      "Frustrated pose 3.jpg",
      "Keyboard 1.jpg"
    ];

    const QUADRANT_POOLS = {
      HVHA: ["Q1_I134_Cat_5.jpg","Q1_I256_Dog_6.jpg","Q1_I262_Dog_12.jpg","Q1_I268_Dog_18.jpg","Q1_I32_Baby_1.jpg","Q1_I334_Fireworks_1.jpg","Q1_I335_Fireworks_2.jpg","Q1_I336_Fireworks_3.jpg","Q1_I339_Fireworks_6.jpg","Q1_I463_Lake_9.jpg","Q1_I466_Lake_12.jpg","Q1_I468_Lake_14.jpg","Q1_I469_Lake_15.jpg","Q1_I516_Nature_1.jpg","Q1_I531_Nude_couple_5.jpg","Q1_I59_Beach_1.jpg","Q1_I60_Beach_2.jpg","Q1_I616_Penguins_2.jpg","Q1_I660_Rainbow_1.jpg","Q1_I661_Rainbow_2.jpg"],
      LVHA: ["Q2_I118_Car_accident_3.jpg","Q2_I150_Cemetery_5.jpg","Q2_I229_Destruction_6.jpg","Q2_I231_Destruction_8.jpg","Q2_I284_Dog_attack_3.jpg","Q2_I303_Explosion_2.jpg","Q2_I304_Explosion_3.jpg","Q2_I306_Explosion_5.jpg","Q2_I319_Fire_2.jpg","Q2_I328_Fire_11.jpg","Q2_I343_Flood_3.jpg","Q2_I451_KKK_rally_1.jpg","Q2_I638_Plane_crash_3.jpg","Q2_I644_Police_5.jpg","Q2_I696_Sad_face_9.jpg","Q2_I788_Soldiers_7.jpg","Q2_I848_Tornado_1.jpg","Q2_I857_Volcano_2.jpg","Q2_I865_War_2.jpg","Q2_I871_War_8.jpg"],
      LVLA: ["Q3_I129_Cardboard_3.jpg","Q3_I227_Destruction_4.jpg","Q3_I230_Destruction_7.jpg","Q3_I235_Destruction_2.jpg","Q3_I236_Destruction_3.jpg","Q3_I240_Dirt_5.jpg","Q3_I309_Feces_1.jpg","Q3_I310_Feces_2.jpg","Q3_I379_Garbage_dump_1.jpg","Q3_I380_Garbage_dump_2.jpg","Q3_I381_Garbage_dump_3.jpg","Q3_I382_Garbage_dump_4.jpg","Q3_I384_Garbage_dump_6.jpg","Q3_I386_Garbage_dump_8.jpg","Q3_I443_Jail_2.jpg","Q3_I600_Paperclips_1.jpg","Q3_I749_Sidewalk_6.jpg","Q3_I862_Wall_4.jpg","Q3_I863_Wall_5.jpg","Q3_I891_Yarn_1.jpg"],
      HVLA: ["Q4_I182_Cotton_swabs_3.jpg","Q4_I254_Dog_4.jpg","Q4_I349_Flowers_6.jpg","Q4_I36_Baby_5.jpg","Q4_I402_Grass_4.jpg","Q4_I455_Lake_1.jpg","Q4_I456_Lake_2.jpg","Q4_I462_Lake_8.jpg","Q4_I464_Lake_10.jpg","Q4_I467_Lake_13.jpg","Q4_I587_Office_supplies_2.jpg","Q4_I597_Paper_3.jpg","Q4_I602_Paperclips_3.jpg","Q4_I673_Rocks_6.jpg","Q4_I743_Siblings_1.jpg","Q4_I74_Bird_1.jpg","Q4_I859_Wall_1.jpg","Q4_I860_Wall_2.jpg","Q4_I861_Wall_3.jpg","Q4_I95_Bricks_1.jpg"]
    };
    const QUADRANT_KEYS = ["HVHA", "HVLA", "LVHA", "LVLA"];

    const PATTERNS = [
      [{ q: "HVHA", c: "Push" }, { q: "HVLA", c: "Push" }, { q: "LVHA", c: "Push" }, { q: "LVLA", c: "Push" }, { q: "LVHA", c: "Poke" }, { q: "LVLA", c: "Poke" }, { q: "HVHA", c: "Poke" }, { q: "HVLA", c: "Poke" }],
      [{ q: "HVLA", c: "Push" }, { q: "LVHA", c: "Push" }, { q: "LVLA", c: "Push" }, { q: "HVHA", c: "Push" }, { q: "LVLA", c: "Poke" }, { q: "HVHA", c: "Poke" }, { q: "HVLA", c: "Poke" }, { q: "LVHA", c: "Poke" }],
      [{ q: "LVHA", c: "Push" }, { q: "LVLA", c: "Push" }, { q: "HVHA", c: "Push" }, { q: "HVLA", c: "Push" }, { q: "HVHA", c: "Poke" }, { q: "HVLA", c: "Poke" }, { q: "LVHA", c: "Poke" }, { q: "LVLA", c: "Poke" }],
      [{ q: "LVLA", c: "Push" }, { q: "HVHA", c: "Push" }, { q: "HVLA", c: "Push" }, { q: "LVHA", c: "Push" }, { q: "HVLA", c: "Poke" }, { q: "LVHA", c: "Poke" }, { q: "LVLA", c: "Poke" }, { q: "HVHA", c: "Poke" }],
      [{ q: "HVHA", c: "Poke" }, { q: "HVLA", c: "Poke" }, { q: "LVHA", c: "Poke" }, { q: "LVLA", c: "Poke" }, { q: "LVHA", c: "Push" }, { q: "LVLA", c: "Push" }, { q: "HVHA", c: "Push" }, { q: "HVLA", c: "Push" }],
      [{ q: "HVLA", c: "Poke" }, { q: "LVHA", c: "Poke" }, { q: "LVLA", c: "Poke" }, { q: "HVHA", c: "Poke" }, { q: "LVLA", c: "Push" }, { q: "HVHA", c: "Push" }, { q: "HVLA", c: "Push" }, { q: "LVHA", c: "Push" }],
      [{ q: "LVHA", c: "Poke" }, { q: "LVLA", c: "Poke" }, { q: "HVHA", c: "Poke" }, { q: "HVLA", c: "Poke" }, { q: "HVHA", c: "Push" }, { q: "HVLA", c: "Push" }, { q: "LVHA", c: "Push" }, { q: "LVLA", c: "Push" }],
      [{ q: "LVLA", c: "Poke" }, { q: "HVHA", c: "Poke" }, { q: "HVLA", c: "Poke" }, { q: "LVHA", c: "Poke" }, { q: "HVLA", c: "Push" }, { q: "LVHA", c: "Push" }, { q: "LVLA", c: "Push" }, { q: "HVHA", c: "Push" }]
    ];

    const slideA = document.getElementById("slideA");
    const slideB = document.getElementById("slideB");
    const viewer = document.getElementById("viewer");
    const controlsPanel = document.getElementById("controlsPanel");
    const toggleControlsBtn = document.getElementById("toggleControlsBtn");
    const statusPanel = document.getElementById("statusPanel");
    const toggleStatusBtn = document.getElementById("toggleStatusBtn");
    const quadrantSelect = document.getElementById("quadrant");
    const participantIdInput = document.getElementById("participantIdInput");
    const seedInput = document.getElementById("seedInput");
    const excludeUsedToggle = document.getElementById("excludeUsedToggle");
    const practiceBtn = document.getElementById("practiceBtn");
    const sessionBtn = document.getElementById("sessionBtn");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const testSoundBtn = document.getElementById("testSoundBtn");
    const resetBtn = document.getElementById("resetBtn");
    const downloadLogBtn = document.getElementById("downloadLogBtn");
    const downloadAllocBtn = document.getElementById("downloadAllocBtn");
    const clearLogBtn = document.getElementById("clearLogBtn");
    const durationInput = document.getElementById("durationInput");
    const fadeInput = document.getElementById("fadeInput");
    const isiInput = document.getElementById("isiInput");
    const fixation = document.getElementById("fixation");
    const statusQuadrant = document.getElementById("statusQuadrant");
    const statusBlock = document.getElementById("statusBlock");
    const statusProgress = document.getElementById("statusProgress");
    const statusFile = document.getElementById("statusFile");
    const badge = document.getElementById("badge");
    const ratingModal = document.getElementById("ratingModal");
    const ratingDoneBtn = document.getElementById("ratingDoneBtn");
    const ratingFrame = document.getElementById("ratingFrame");
    const ratingModalTitle = document.getElementById("ratingModalTitle");

    const audio = new Audio(NOTIFY_AUDIO);
    audio.preload = "auto";

    let activeSlide = slideA;
    let idleSlide = slideB;
    let timerId = null;
    let notificationTimerId = null;
    let isPlaying = false;
    let showingImage = true;
    let currentIndex = 0;
    let lastStartTime = 0;
    let remainingMs = 0;
    let modalOpen = false;
    let modalPurpose = null;
    let ratingSavedForCurrentPause = false;
    let seedValue = null;
    let sessionBlocks = [];
    let sessionPointer = 0;
    let currentBlock = null;
    let currentSessionDatetime = "";
    let logStartTime = null;
    let ratingPayloadLatest = null;
    const usedImages = new Set();
    const logRows = [];
    const assignmentRows = [];

    const moves = [
      { fromX: "-4%", fromY: "-3%", toX: "2%", toY: "2%" },
      { fromX: "3%", fromY: "-2%", toX: "-2%", toY: "3%" },
      { fromX: "-3%", fromY: "2%", toX: "3%", toY: "-2%" },
      { fromX: "2%", fromY: "3%", toX: "-3%", toY: "-2%" }
    ];

    function hashStringToSeed(text) {
      let h = 2166136261 >>> 0;
      for (let i = 0; i < text.length; i += 1) {
        h ^= text.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function mulberry32(a) {
      return function() {
        let t = a += 0x6d2b79f5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function createRng(seed) {
      return mulberry32(seed >>> 0);
    }

    function randInt(rng, min, max) {
      return min + Math.floor(rng() * (max - min + 1));
    }

    function shuffledCopy(arr, rng) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i -= 1) {
        const j = randInt(rng, 0, i);
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function formatDateTime(date) {
      const p = (n) => String(n).padStart(2, "0");
      return `${date.getFullYear()}/${p(date.getMonth() + 1)}/${p(date.getDate())} ${p(date.getHours())}:${p(date.getMinutes())}:${p(date.getSeconds())}`;
    }

    function formatCompact(date) {
      const p = (n) => String(n).padStart(2, "0");
      return `${date.getFullYear()}${p(date.getMonth() + 1)}${p(date.getDate())}_${p(date.getHours())}${p(date.getMinutes())}${p(date.getSeconds())}`;
    }

    function formatElapsed(ms) {
      const s = Math.max(0, Math.floor(ms / 1000));
      const m = Math.floor(s / 60);
      return `${m}:${String(s % 60).padStart(2, "0")}`;
    }

    function getParticipantId() {
      return (participantIdInput.value || "P00").trim() || "P00";
    }

    function getSeed() {
      const user = (seedInput.value || "").trim();
      if (user !== "") return Number(user) >>> 0;
      const derived = hashStringToSeed(getParticipantId());
      seedInput.value = String(derived);
      return derived;
    }

    function getConfig() {
      return {
        durationMs: Math.max(1000, Number(durationInput.value) || 5000),
        fadeMs: Math.max(0, Number(fadeInput.value) || 0),
        isiMs: Math.max(0, Number(isiInput.value) || 0)
      };
    }

    function computeNotifOnsetMsFromBlockStart(notifTrial, onsetInTrialMs, cfg) {
      return (notifTrial - 1) * (cfg.durationMs + cfg.isiMs) + onsetInTrialMs;
    }

    function sampleImages(pool, sampleN, rng, useGlobalNoRepeat, quadrant) {
      let candidates = pool.slice();
      let note = "block_no_repeat_only";
      if (useGlobalNoRepeat) {
        const filtered = candidates.filter((x) => !usedImages.has(x));
        if (filtered.length >= sampleN) {
          candidates = filtered;
          note = "participant_no_repeat_enabled";
        } else {
          note = `participant_no_repeat_fallback:${quadrant}`;
        }
      }
      const sampled = shuffledCopy(candidates, rng).slice(0, sampleN);
      sampled.forEach((f) => usedImages.add(f));
      return { sampled, note };
    }

    function buildQuadrantSplitSets(participantSeed) {
      const sets = {};
      QUADRANT_KEYS.forEach((quadrant) => {
        const pool = QUADRANT_POOLS[quadrant];
        const splitSeed = hashStringToSeed(`${participantSeed}:${quadrant}:split`);
        const splitRng = createRng(splitSeed);
        const shuffled = shuffledCopy(pool, splitRng);
        const assignSeed = hashStringToSeed(`${participantSeed}:${quadrant}:assign`);
        const assignRng = createRng(assignSeed);
        const firstHalfIsPush = assignRng() < 0.5;
        sets[quadrant] = {
          Push: firstHalfIsPush ? shuffled.slice(0, 10) : shuffled.slice(10, 20),
          Poke: firstHalfIsPush ? shuffled.slice(10, 20) : shuffled.slice(0, 10),
          split_seed: splitSeed,
          split_assignment: firstHalfIsPush ? "first_half=Push" : "first_half=Poke"
        };
      });
      return sets;
    }

    function buildUiConditionMap(rng) {
      const flip = rng() < 0.5;
      return flip
        ? { Push: UI_LABELS[0], Poke: UI_LABELS[1] }
        : { Push: UI_LABELS[1], Poke: UI_LABELS[0] };
    }

    function resolvePatternIndex(participantId) {
      const num = Number(String(participantId).replace(/[^\d]/g, ""));
      if (Number.isFinite(num) && num > 0) return (num - 1) % PATTERNS.length;
      return hashStringToSeed(participantId) % PATTERNS.length;
    }

    function selectNotifTrial(trueCondition, rng) {
      if (trueCondition === "Push") return randInt(rng, 2, 9);
      if (trueCondition === "Poke") return randInt(rng, 6, 9);
      return randInt(rng, 4, 8);
    }

    function selectJitterMs(trueCondition, rng) {
      if (trueCondition === "Push") return 0;
      if (trueCondition === "Poke") return randInt(rng, -NOTIF_JITTER_RANGE_MS, NOTIF_JITTER_RANGE_MS);
      return randInt(rng, -NOTIF_JITTER_RANGE_MS, NOTIF_JITTER_RANGE_MS);
    }

    function generateSessionBlocks() {
      const participantId = getParticipantId();
      const cfg = getConfig();
      seedValue = getSeed();
      const rng = createRng(seedValue);
      const quadrantSplitSets = buildQuadrantSplitSets(seedValue);
      const uiMap = buildUiConditionMap(rng);
      const patternIdx = resolvePatternIndex(participantId);
      const basePattern = PATTERNS[patternIdx];
      sessionBlocks = [];
      assignmentRows.length = 0;

      for (let i = 0; i < basePattern.length; i += 1) {
        const row = basePattern[i];
        const blockOrderSeed = hashStringToSeed(`${seedValue}:${row.q}:${row.c}:block`);
        const blockOrderRng = createRng(blockOrderSeed);
        const sampled = shuffledCopy(quadrantSplitSets[row.q][row.c], blockOrderRng);
        const splitAssignment = quadrantSplitSets[row.q].split_assignment;
        const note = `quadrant_split_once:${row.c}:seed=${quadrantSplitSets[row.q].split_seed}:${splitAssignment}:block_order_seed=${blockOrderSeed}`;
        const jitterMs = selectJitterMs(row.c, rng);
        const notifTrial = selectNotifTrial(row.c, rng);
        const onsetInTrial = NOTIF_BASE_MS + jitterMs;
        const onsetBlock = computeNotifOnsetMsFromBlockStart(notifTrial, onsetInTrial, cfg);
        const block = {
          block_index: i + 1,
          is_practice: false,
          quadrant: row.q,
          true_condition: row.c,
          ui_label: uiMap[row.c],
          sampled_image_ids: sampled,
          notif_trial: notifTrial,
          jitter_ms: jitterMs,
          notif_onset_ms_from_trial_start: onsetInTrial,
          notif_onset_ms_from_block_start: onsetBlock,
          random_seed: seedValue,
          sample_note: note,
          split_assignment: splitAssignment
        };
        sessionBlocks.push(block);
        assignmentRows.push({
          participant_id: participantId,
          block_index: block.block_index,
          quadrant: block.quadrant,
          true_condition: block.true_condition,
          ui_label: block.ui_label,
          notif_trial: block.notif_trial,
          notif_onset_ms_from_trial_start: block.notif_onset_ms_from_trial_start,
          random_seed: block.random_seed,
          sampled_image_ids: block.sampled_image_ids.join("|"),
          jitter_ms: block.jitter_ms,
          is_practice: false,
          split_assignment: block.split_assignment
        });
      }
      sessionPointer = 0;
      logEvent("session_generated", { detail: `pattern=${patternIdx + 1}`, sampled_image_ids: "" });
    }

    function generatePracticeBlock() {
      const participantId = getParticipantId();
      const cfg = getConfig();
      seedValue = getSeed();
      const rng = createRng((seedValue + 9871) >>> 0);
      const sampled = shuffledCopy(PRACTICE_IMAGE_POOL, rng).slice(0, 10);
      const jitterMs = selectJitterMs("Practice", rng);
      const notifTrial = randInt(rng, 4, 8);
      const onsetInTrial = NOTIF_BASE_MS + jitterMs;
      const block = {
        block_index: 1,
        is_practice: true,
        quadrant: "MIXED",
        true_condition: "Practice",
        ui_label: "Practice",
        sampled_image_ids: sampled,
        notif_trial: notifTrial,
        jitter_ms: jitterMs,
        notif_onset_ms_from_trial_start: onsetInTrial,
        notif_onset_ms_from_block_start: computeNotifOnsetMsFromBlockStart(notifTrial, onsetInTrial, cfg),
        random_seed: seedValue,
        sample_note: `practice_custom_pool=${PRACTICE_IMAGE_POOL.length};participant=${participantId}`,
        image_base_path: practiceBasePath
      };
      return block;
    }

    function escapeCsv(v) {
      const text = String(v ?? "");
      const escaped = text.replace(/"/g, "\"\"");
      return /[",\n]/.test(escaped) ? `"${escaped}"` : escaped;
    }

    function downloadCsv(rows, filename, header) {
      const lines = [header.join(",")];
      rows.forEach((row) => {
        lines.push(header.map((h) => escapeCsv(row[h])).join(","));
      });
      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function downloadLogCsv() {
      const header = [
        "participant_id","session_datetime","DateTime","Elapsed","event","detail","block_index","is_practice",
        "quadrant","true_condition","condition","ui_label","trial_index","trial_index_in_block","file","image_id","notif_trial","notif_trial_index","jitter_ms",
        "notif_onset_ms_from_trial_start","notif_onset_ms_from_block_start","slider_response","slider_rt_ms",
        "sampled_image_ids","random_seed","sample_note","split_assignment"
      ];
      const stamp = formatCompact(new Date());
      const name = `oasis_log_${getParticipantId()}_${stamp}.csv`;
      downloadCsv(logRows, name, header);
    }

    function downloadAssignmentCsv() {
      const header = [
        "participant_id","block_index","quadrant","true_condition","ui_label","notif_trial",
        "notif_onset_ms_from_trial_start","random_seed","sampled_image_ids","jitter_ms","is_practice","split_assignment"
      ];
      const stamp = formatCompact(new Date());
      const name = `assignment_${getParticipantId()}_${stamp}.csv`;
      downloadCsv(assignmentRows, name, header);
    }

    function setKenBurns(slide) {
      const { durationMs, fadeMs } = getConfig();
      const rng = createRng(hashStringToSeed(`${seedValue || 0}:${Date.now()}`));
      const move = moves[randInt(rng, 0, moves.length - 1)];
      const fromScale = (1.03 + rng() * 0.04).toFixed(3);
      const toScale = (1.08 + rng() * 0.05).toFixed(3);
      slide.style.setProperty("--from-x", move.fromX);
      slide.style.setProperty("--from-y", move.fromY);
      slide.style.setProperty("--to-x", move.toX);
      slide.style.setProperty("--to-y", move.toY);
      slide.style.setProperty("--from-scale", fromScale);
      slide.style.setProperty("--to-scale", toScale);
      slide.style.setProperty("--duration-ms", `${durationMs}ms`);
      slide.style.setProperty("--fade-ms", `${fadeMs}ms`);
    }

    function updatePresentationMode() {
      const hideControls = Boolean(currentBlock) && (isPlaying || modalOpen);
      document.body.classList.toggle("presentation-mode", hideControls);
    }

    function updateStatus() {
      const files = currentBlock ? currentBlock.sampled_image_ids : [];
      const totalBlocks = currentBlock
        ? (currentBlock.is_practice ? 1 : (sessionBlocks.length || 8))
        : (sessionBlocks.length || 8);
      statusBlock.textContent = currentBlock ? `${currentBlock.block_index} / ${totalBlocks}` : "-";
      statusQuadrant.textContent = currentBlock ? `${currentBlock.quadrant} / ${currentBlock.ui_label}` : quadrantSelect.value;
      statusProgress.textContent = files.length ? `${Math.min(currentIndex + 1, files.length)} / ${files.length}` : "0 / 10";
      statusFile.textContent = files[currentIndex] || "-";
      badge.textContent = `${files.length || 10} images`;
    }

    function swapSlides() {
      const t = activeSlide;
      activeSlide = idleSlide;
      idleSlide = t;
    }

    function logEvent(event, extra = {}) {
      const now = new Date();
      if (!logStartTime) logStartTime = now;
      const elapsed = formatElapsed(now - logStartTime);
      const trialIndex = currentIndex + 1;
      const file = currentBlock?.sampled_image_ids?.[currentIndex] || "";
      const row = {
        participant_id: getParticipantId(),
        session_datetime: currentSessionDatetime,
        DateTime: formatDateTime(now),
        Elapsed: elapsed,
        event,
        detail: extra.detail || "",
        block_index: currentBlock ? currentBlock.block_index : "",
        is_practice: currentBlock ? String(currentBlock.is_practice) : "",
        quadrant: currentBlock ? currentBlock.quadrant : "",
        true_condition: currentBlock ? currentBlock.true_condition : "",
        condition: currentBlock ? currentBlock.true_condition : "",
        ui_label: currentBlock ? currentBlock.ui_label : "",
        trial_index: trialIndex,
        trial_index_in_block: trialIndex,
        file,
        image_id: file,
        notif_trial: currentBlock ? currentBlock.notif_trial : "",
        notif_trial_index: currentBlock ? currentBlock.notif_trial : "",
        jitter_ms: currentBlock ? currentBlock.jitter_ms : "",
        notif_onset_ms_from_trial_start: currentBlock ? currentBlock.notif_onset_ms_from_trial_start : "",
        notif_onset_ms_from_block_start: currentBlock ? currentBlock.notif_onset_ms_from_block_start : "",
        slider_response: extra.slider_response || (ratingPayloadLatest ? JSON.stringify(ratingPayloadLatest.response || {}) : ""),
        slider_rt_ms: extra.slider_rt_ms ?? (ratingPayloadLatest?.slider_rt_ms ?? ""),
        sampled_image_ids: extra.sampled_image_ids ?? (currentBlock ? currentBlock.sampled_image_ids.join("|") : ""),
        random_seed: currentBlock ? currentBlock.random_seed : (seedValue ?? ""),
        sample_note: currentBlock ? currentBlock.sample_note : "",
        split_assignment: currentBlock ? (currentBlock.split_assignment || "") : ""
      };
      logRows.push(row);
    }

    function loadRatingFrame() {
      ratingFrame.src = `${RATING_PAGE_URL}?v=${RATING_PAGE_VERSION}`;
    }

    function requestAffectiveCsvExport() {
      if (!ratingFrame.contentWindow) return;
      ratingFrame.contentWindow.postMessage({ type: "affective-slider-export-csv" }, "*");
      logEvent("request_affective_export");
    }

    function openRatingModal(purpose) {
      if (modalOpen) return;
      modalOpen = true;
      modalPurpose = purpose;
      ratingSavedForCurrentPause = false;
      ratingDoneBtn.disabled = true;
      if (purpose === "pre") ratingModalTitle.textContent = "開始前評価を入力してください / Pre-block rating";
      else if (purpose === "post") ratingModalTitle.textContent = "終了時評価を入力してください / Post-block rating";
      else ratingModalTitle.textContent = "途中評価を入力してください / In-block rating";
      ratingModal.classList.add("open");
      ratingModal.setAttribute("aria-hidden", "false");
      logEvent("rating_modal_open", { detail: purpose });
      updatePresentationMode();
    }

    function closeRatingModal() {
      if (!modalOpen) return;
      ratingModal.classList.remove("open");
      ratingModal.setAttribute("aria-hidden", "true");
      ratingDoneBtn.disabled = true;
      logEvent("rating_modal_close", { detail: modalPurpose || "" });
      modalPurpose = null;
      modalOpen = false;
      updatePresentationMode();
    }

    function clearTimers() {
      clearTimeout(timerId);
      clearTimeout(notificationTimerId);
      timerId = null;
      notificationTimerId = null;
    }

    async function triggerNotification() {
      if (!currentBlock || !isPlaying || !showingImage || currentBlock.notificationFired) return;
      currentBlock.notificationFired = true;
      logEvent("notification_onset");
      let played = false;
      try {
        audio.currentTime = 0;
        await audio.play();
        played = true;
      } catch (err) {
        logEvent("notification_audio_failed", { detail: String(err) });
      }
      // Show the questionnaire immediately after notification playback starts.
      if (played) {
        setTimeout(() => {
          pausePlayback("notification");
          openRatingModal("notification");
        }, 40);
        return;
      }
      pausePlayback("notification");
      openRatingModal("notification");
    }

    function showImage(index) {
      if (!currentBlock) return;
      const files = currentBlock.sampled_image_ids;
      if (index >= files.length) return;
      const file = files[index];
      fixation.classList.remove("active");
      idleSlide.classList.remove("active");
      const blockBasePath = currentBlock.image_base_path || basePath;
      idleSlide.style.backgroundImage = `url(${blockBasePath}${encodeURI(file)})`;
      setKenBurns(idleSlide);
      idleSlide.style.animation = "none";
      void idleSlide.offsetHeight;
      idleSlide.style.animation = "kenburns var(--duration-ms) linear forwards";
      idleSlide.classList.add("active");
      activeSlide.classList.remove("active");
      swapSlides();
      updateStatus();
      logEvent("image");

      if (index + 1 === currentBlock.notif_trial) {
        clearTimeout(notificationTimerId);
        notificationTimerId = setTimeout(() => {
          triggerNotification();
        }, currentBlock.notif_onset_ms_from_trial_start);
      }
    }

    function scheduleNext(ms) {
      clearTimeout(timerId);
      timerId = setTimeout(() => {
        if (!isPlaying || !currentBlock) return;
        const cfg = getConfig();
        if (showingImage) {
          fixation.classList.add("active");
          activeSlide.classList.remove("active");
          idleSlide.classList.remove("active");
          showingImage = false;
          lastStartTime = Date.now();
          logEvent("fixation");
          if (currentIndex >= currentBlock.sampled_image_ids.length - 1) {
            isPlaying = false;
            viewer.classList.remove("paused");
            pauseBtn.disabled = true;
            startBtn.disabled = true;
            openRatingModal("post");
            logEvent("block_end");
            return;
          }
          scheduleNext(cfg.isiMs);
          return;
        }
        currentIndex += 1;
        showingImage = true;
        lastStartTime = Date.now();
        showImage(currentIndex);
        scheduleNext(cfg.durationMs);
      }, ms);
    }

    function startPlayback() {
      if (!currentBlock) return;
      clearTimers();
      currentIndex = 0;
      currentBlock.notificationFired = false;
      ratingPayloadLatest = null;
      isPlaying = true;
      showingImage = true;
      viewer.classList.remove("paused");
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      sessionBtn.disabled = true;
      practiceBtn.disabled = true;
      updateStatus();
      showImage(currentIndex);
      const cfg = getConfig();
      lastStartTime = Date.now();
      scheduleNext(cfg.durationMs);
      logEvent("block_start");
      updatePresentationMode();
    }

    function pausePlayback(reason = "manual") {
      if (!isPlaying) return;
      const cfg = getConfig();
      const elapsed = Date.now() - lastStartTime;
      remainingMs = Math.max(0, (showingImage ? cfg.durationMs : cfg.isiMs) - elapsed);
      clearTimers();
      isPlaying = false;
      viewer.classList.add("paused");
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      logEvent("pause", { detail: reason });
      updatePresentationMode();
    }

    function resumePlayback() {
      if (isPlaying || !currentBlock) return;
      if (modalOpen) return;
      isPlaying = true;
      viewer.classList.remove("paused");
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      lastStartTime = Date.now();
      const cfg = getConfig();
      scheduleNext(remainingMs || (showingImage ? cfg.durationMs : cfg.isiMs));
      logEvent("resume");
      updatePresentationMode();
    }

    function finalizeBlock() {
      clearTimers();
      isPlaying = false;
      viewer.classList.remove("paused");
      pauseBtn.disabled = true;
      startBtn.disabled = true;
      practiceBtn.disabled = false;
      sessionBtn.disabled = false;
      logEvent("block_finalize");
      updatePresentationMode();
    }

    function resetPlayback() {
      clearTimers();
      closeRatingModal();
      isPlaying = false;
      currentIndex = 0;
      remainingMs = 0;
      currentBlock = null;
      viewer.classList.remove("paused");
      activeSlide.classList.remove("active");
      idleSlide.classList.remove("active");
      fixation.classList.add("active");
      statusFile.textContent = "-";
      statusProgress.textContent = "0 / 10";
      statusBlock.textContent = "-";
      statusQuadrant.textContent = "-";
      startBtn.disabled = true;
      pauseBtn.disabled = true;
      sessionBtn.disabled = false;
      practiceBtn.disabled = false;
      logEvent("reset");
      updatePresentationMode();
    }

    function startPracticeFlow() {
      if (isPlaying || modalOpen) return;
      currentSessionDatetime = formatDateTime(new Date());
      currentBlock = generatePracticeBlock();
      assignmentRows.push({
        participant_id: getParticipantId(),
        block_index: currentBlock.block_index,
        quadrant: currentBlock.quadrant,
        true_condition: currentBlock.true_condition,
        ui_label: currentBlock.ui_label,
        notif_trial: currentBlock.notif_trial,
        notif_onset_ms_from_trial_start: currentBlock.notif_onset_ms_from_trial_start,
        random_seed: currentBlock.random_seed,
        sampled_image_ids: currentBlock.sampled_image_ids.join("|"),
        jitter_ms: currentBlock.jitter_ms,
        is_practice: true
      });
      updateStatus();
      openRatingModal("pre");
      logEvent("practice_ready");
    }

    function startNextSessionBlock() {
      if (isPlaying || modalOpen) return;
      if (sessionBlocks.length === 0 || sessionPointer >= sessionBlocks.length) {
        generateSessionBlocks();
        const selectedStart = Math.max(0, quadrantSelect.selectedIndex);
        sessionPointer = Math.min(selectedStart, Math.max(0, sessionBlocks.length - 1));
      }
      if (sessionPointer >= sessionBlocks.length) {
        logEvent("session_complete");
        return;
      }
      currentSessionDatetime = formatDateTime(new Date());
      currentBlock = sessionBlocks[sessionPointer];
      sessionPointer += 1;
      updateStatus();
      openRatingModal("pre");
      logEvent("block_ready", { detail: `block=${currentBlock.block_index}` });
    }

    function handleRatingModalDone() {
      if (!ratingSavedForCurrentPause) return;
      const purpose = modalPurpose;
      closeRatingModal();
      if (purpose === "pre") {
        startPlayback();
        return;
      }
      if (purpose === "notification") {
        resumePlayback();
        return;
      }
      if (purpose === "post") {
        finalizeBlock();
      }
    }

    toggleControlsBtn.addEventListener("click", () => {
      controlsPanel.classList.toggle("collapsed");
      toggleControlsBtn.textContent = controlsPanel.classList.contains("collapsed") ? "開く" : "閉じる";
      logEvent("controls_toggle", { detail: controlsPanel.classList.contains("collapsed") ? "collapsed" : "expanded" });
    });

    toggleStatusBtn.addEventListener("click", () => {
      statusPanel.classList.toggle("collapsed");
      toggleStatusBtn.textContent = statusPanel.classList.contains("collapsed") ? "開く" : "閉じる";
      logEvent("status_toggle", { detail: statusPanel.classList.contains("collapsed") ? "collapsed" : "expanded" });
    });

    practiceBtn.addEventListener("click", startPracticeFlow);
    sessionBtn.addEventListener("click", startNextSessionBlock);
    startBtn.addEventListener("click", resumePlayback);
    pauseBtn.addEventListener("click", () => pausePlayback("manual"));
    testSoundBtn.addEventListener("click", async () => {
      try {
        audio.currentTime = 0;
        await audio.play();
        logEvent("test_sound");
      } catch (err) {
        logEvent("test_sound_failed", { detail: String(err) });
      }
    });
    resetBtn.addEventListener("click", resetPlayback);

    downloadLogBtn.addEventListener("click", () => {
      logEvent("download_log");
      downloadLogCsv();
      requestAffectiveCsvExport();
    });

    downloadAllocBtn.addEventListener("click", () => {
      logEvent("download_assignment");
      downloadAssignmentCsv();
    });

    clearLogBtn.addEventListener("click", () => {
      logRows.length = 0;
      logStartTime = null;
      logEvent("log_cleared");
    });

    ratingDoneBtn.addEventListener("click", handleRatingModalDone);

    ratingFrame.addEventListener("load", () => {
      logEvent("rating_frame_loaded");
    });

    window.addEventListener("message", (event) => {
      if (event.source !== ratingFrame.contentWindow) return;
      if (!event.data || !event.data.type) return;

      if (event.data.type === "affective-slider-saved") {
        ratingSavedForCurrentPause = true;
        ratingDoneBtn.disabled = false;
        ratingPayloadLatest = event.data.payload || null;
        logEvent("rating_saved", {
          slider_response: ratingPayloadLatest ? JSON.stringify(ratingPayloadLatest.response || {}) : "",
          slider_rt_ms: ratingPayloadLatest ? ratingPayloadLatest.slider_rt_ms || "" : ""
        });
        return;
      }
      if (event.data.type === "affective-slider-exported") {
        logEvent("affective_exported");
        return;
      }
      if (event.data.type === "affective-slider-export-empty") {
        logEvent("affective_export_empty");
      }
    });

    fixation.classList.add("active");
    loadRatingFrame();
    updateStatus();
    startBtn.disabled = true;
    pauseBtn.disabled = true;
    updatePresentationMode();
  </script>
</body>
</html>
