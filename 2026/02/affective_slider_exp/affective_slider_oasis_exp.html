<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AffectiveSlider</title>
<style>
  .emotion-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 64px;
  }

  .emotion-icon {
    width: 44px;
    height: 50px;
    margin: 0 10px;
  }

  .emotion-slider-group {
    display: flex;
    flex-direction: column; /* スライダーと画像を縦並びに */
    align-items: center;
  }

  #stress, #arousal, #pleasure {
    width: 400px;
    height: 12px; /* スライダーの太さ */
    -webkit-appearance: none;
    appearance: none;
    background-color: white; /* スライダーの塗りつぶし */
    border: 1px solid black; /* スライダーの枠線 */
    border-radius: 10px;
    cursor: pointer;
  }

  #stress::-webkit-slider-thumb, #arousal::-webkit-slider-thumb, #pleasure::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 23px;
    background-color: white;
    border: 3px solid black;
    border-radius: 10px;
    cursor: pointer;
  }

  #stress::-moz-range-thumb, #arousal::-moz-range-thumb, #pleasure::-moz-range-thumb {
    width: 25px;
    height: 23px;
    background-color: white;
    border: 3px solid black;
    border-radius: 10px;
    cursor: pointer;
  }

  #stress.hide-thumb::-webkit-slider-thumb,
  #arousal.hide-thumb::-webkit-slider-thumb,
  #pleasure.hide-thumb::-webkit-slider-thumb {
    opacity: 0;
  }

  #stress.hide-thumb::-moz-range-thumb,
  #arousal.hide-thumb::-moz-range-thumb,
  #pleasure.hide-thumb::-moz-range-thumb {
    opacity: 0;
  }

  .single-pole-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .single-pole-label {
    width: 120px;
    font-size: 12px;
    color: #444;
    line-height: 1.2;
  }

  .single-pole-label.left {
    text-align: right;
  }

  .single-pole-label.right {
    text-align: left;
  }

  .gradient-arrow {
    width: 416px; /* スライダーの幅に合わせて画像の幅を調整 */
    height: 28px;
    margin-top: 2px;
  }

  .actions {
    text-align: center;
    margin-bottom: 20px;
    margin-top: 10px;
  }

  .actions img {
    width: 24px;
    height: 24px;
    cursor: pointer;
    filter: brightness(0) invert(50%);
    margin: 0 10px;
  }

  .log {
    text-align: left;
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #ccc;
    width: 600px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    display: none;
  }

  .submit-button {
    text-align: center;
    margin-top: 20px;
  }

  .submit-btn {
    width: 120px;
    height: 40px;
    cursor: pointer;
    border: 2px solid black;
    border-radius: 30px;
    background: #fff;
    position: relative;
    transition: background-color 0.3s, border-color 0.3s, transform 0.12s ease, opacity 0.12s ease;
    margin-top: 32px;
    user-select: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .submit-btn svg {
    width: 24px;
    height: 24px;
    fill: #000;
    transition: fill 0.3s ease;
  }

  .submit-btn:hover {
    background-color: #dcdcdc;
    border-color: #000;
  }

  .submit-btn:hover svg {
    fill: #000;
  }

  .pulse {
    animation: pulse 260ms ease;
  }

  .submit-btn.flash {
    background-color: #d9f4e1;
    border-color: #1f7a4f;
  }

  .submit-btn.flash svg {
    fill: #1f7a4f;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.04); }
    100% { transform: scale(1); }
  }

  /* 保存中（連打防止） */
  .submit-btn.saving {
    pointer-events: none;
    opacity: 0.55;
    transform: scale(0.98);
  }

  .submit-btn:disabled {
    pointer-events: none;
    opacity: 0.55;
    transform: scale(0.98);
    background-color: #f5f5f5;
  }

  /* フッターのスタイル */
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #f1f1f1;
    text-align: center;
    padding: 10px;
    font-size: 14px;
  }

  footer a {
    color: #0066cc;
    text-decoration: none;
  }

  footer a:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<!-- 画面最上部のリンク -->
<div class="actions">
  <img id="resetButton" src="restart_alt_40dp_E8EAED_FILL0_wght400_GRAD0_opsz40.svg" alt="ログのリセット">
  <img id="toggleLogButton" src="visibility_off_40dp_E8EAED_FILL0_wght400_GRAD0_opsz40.svg" alt="操作ログの表示/非表示">
  <img id="downloadLogButton" src="download_40dp_E8EAED_FILL0_wght400_GRAD0_opsz40.svg" alt="ログのダウンロード">
</div>

<!-- 1本目のスライダー: sleep - surprised（arousal） -->
<div class="emotion-container">
  <div class="emotion-slider-group">
    <div class="single-pole-row">
      <span class="single-pole-label left">全く感じていない</span>
      <input type="range" id="stress" min="0" max="100" value="50" aria-label="Stress (0-100)">
      <span class="single-pole-label right">きわめて強く感じている</span>
    </div>
  </div>
</div>

<!-- 2本目のスライダー: sleep - surprised（arousal） -->
<div class="emotion-container">
  <img src="sleep.png" alt="Sleepy" class="emotion-icon">
  <div class="emotion-slider-group">
    <input type="range" id="arousal" min="0" max="100" value="50">
    <img src="path_to_image.png" class="gradient-arrow" alt="Gradient Arrow">
  </div>
  <img src="surprised.png" alt="Surprised" class="emotion-icon">
</div>

<!-- 3本目のスライダー: sad - happy（pleasure） -->
<div class="emotion-container">
  <img src="sad.png" alt="Sad" class="emotion-icon">
  <div class="emotion-slider-group">
    <input type="range" id="pleasure" min="0" max="100" value="50">
    <img src="path_to_image.png" class="gradient-arrow" alt="Gradient Arrow">
  </div>
  <img src="happy.png" alt="Happy" class="emotion-icon">
</div>

<!-- saveアイコン -->
<div class="submit-button">
  <button id="submitButton" class="submit-btn" type="button" aria-label="Save">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
      <path d="M379.33-244 154-469.33 201.67-517l177.66 177.67 378.34-378.34L805.33-670l-426 426Z"/>
    </svg>
  </button>
</div>

<!-- ログ表示エリア -->
<div class="log" id="logContainer">
  <h3>log:</h3>
  <ul id="logList"></ul>
</div>

<!-- フッター -->
<footer>
  <p>
    <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4743948/" target="_blank">
      The Affective Slider: A Digital Self-Assessment Scale for the Measurement of Human Emotions
    </a>
  </p>
</footer>

<script>
const stressSlider = document.getElementById('stress');
const arousalSlider = document.getElementById('arousal');
const pleasureSlider = document.getElementById('pleasure');
const logList = document.getElementById('logList');
const resetButton = document.getElementById('resetButton');
const toggleLogButton = document.getElementById('toggleLogButton');
const downloadLogButton = document.getElementById('downloadLogButton');
const logContainer = document.getElementById('logContainer');
const submitButton = document.getElementById('submitButton');

let logEntries = [];          // ログを保存する配列
let lastLogTimestamp = '';    // 最後の操作ログのタイムスタンプ（HHMMSS）
let saveLock = false;         // 連打防止（保存処理中フラグ）
let feedbackTimer = null;     // アニメーション用タイマー
let touched = { stress: false, arousal: false, pleasure: false };
let firstInteractionAtMs = null;

function setSaveEnabled(enabled) {
  submitButton.disabled = !enabled;
}

function canSave() {
  return touched.stress && touched.arousal && touched.pleasure;
}

function markTouched(key) {
  touched[key] = true;
  if (firstInteractionAtMs === null) {
    firstInteractionAtMs = Date.now();
  }
  setSaveEnabled(canSave());
}

// Hide both thumbs until the user interacts again.
function hideThumbs() {
  stressSlider.classList.add('hide-thumb');
  arousalSlider.classList.add('hide-thumb');
  pleasureSlider.classList.add('hide-thumb');
}

// Show only the thumb for the slider the user touched.
function showThumbFor(target) {
  if (target === stressSlider) {
    stressSlider.classList.remove('hide-thumb');
  }
  if (target === arousalSlider) {
    arousalSlider.classList.remove('hide-thumb');
  }
  if (target === pleasureSlider) {
    pleasureSlider.classList.remove('hide-thumb');
  }
}

// 今日の日付を YYYYMMDD 形式で取得（ファイル名用）
function getTodayYYYYMMDD() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}${m}${day}`;
}

// CSVファイルのダウンロード処理
function downloadCSV(content, fileName) {
  const a = document.createElement('a');
  const blob = new Blob([content], { type: 'text/csv' });
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// CSV形式でのログ出力
function exportLogToCSV() {
  const header = 'Time,stress,arousal,pleasure\n';
  const rows = logEntries.map(entry => `${entry.time},${entry.stress},${entry.arousal},${entry.pleasure}`).join('\n');
  const csvContent = header + rows;

  // ★ ファイル名に「今日の日付(YYYYMMDD)」を追加
  // 例: 20260213_131819_affectivesliderexp.csv
  const today = getTodayYYYYMMDD();
  const fileName = `${today}_${lastLogTimestamp}_affectivesliderexp.csv`;

  downloadCSV(csvContent, fileName);
}

function pulseElement(el) {
  if (!el) return;
  if (feedbackTimer) clearTimeout(feedbackTimer);
  el.classList.remove('pulse');
  void el.offsetWidth;
  el.classList.add('pulse');
  feedbackTimer = setTimeout(() => {
    el.classList.remove('pulse');
  }, 300);
}

function flashSaveButton() {
  submitButton.classList.add('flash');
  setTimeout(() => {
    submitButton.classList.remove('flash');
  }, 380);
}

// ログを送信した際に追加・表示する関数
function addLogEntry() {
  if (submitButton.disabled) return;
  if (saveLock) return; // 連打防止
  saveLock = true;
  submitButton.classList.add('saving');
  setSaveEnabled(false);

  const arousalValue = arousalSlider.value;    // arousal スライダーの値
  const pleasureValue = pleasureSlider.value;  // pleasure スライダーの値
  const stressValue = stressSlider.value;      // stress スライダーの値
  const currentTime = new Date();              // タイムスタンプ
  const nowMs = Date.now();

  // タイムスタンプを hh:mm:ss 形式に
  const formattedTime = currentTime.toLocaleTimeString('ja-JP');

  // ファイル名用に HHMMSS を保持（元仕様維持）
  lastLogTimestamp = formattedTime.replace(/:/g, "");

  // ログを配列に追加
  logEntries.push({
    time: formattedTime,
    stress: stressValue,
    arousal: arousalValue,
    pleasure: pleasureValue
  });

  // ログを更新して表示
  updateLogDisplay();

  // 保存時の非言語フィードバック（パルス＋一瞬緑）
  pulseElement(submitButton);
  flashSaveButton();

  // スライダーを中央に戻す
  stressSlider.value = 50;
  arousalSlider.value = 50;
  pleasureSlider.value = 50;
  hideThumbs();

  touched = { stress: false, arousal: false, pleasure: false };
  const sliderRtMs = firstInteractionAtMs === null ? null : (nowMs - firstInteractionAtMs);
  firstInteractionAtMs = null;
  setSaveEnabled(false);

  // 連打防止解除（短時間だけ無効化して二重保存を物理的に防ぐ）
  setTimeout(() => {
    saveLock = false;
    submitButton.classList.remove('saving');
  }, 550);

  // Notify the parent viewer that a rating has been saved.
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({
      type: 'affective-slider-saved',
      payload: {
        response: {
          stress: Number(stressValue),
          arousal: Number(arousalValue),
          pleasure: Number(pleasureValue)
        },
        slider_rt_ms: sliderRtMs
      }
    }, '*');
  }
}

// ログを表示する関数
function updateLogDisplay() {
  logList.innerHTML = '';  // ログ表示をクリア
  logEntries.forEach(entry => {
    const logItem = document.createElement('li');
    logItem.textContent = `time: ${entry.time}, stress: ${entry.stress}, arousal: ${entry.arousal}, pleasure: ${entry.pleasure}`;
    logList.appendChild(logItem);
  });
}

stressSlider.addEventListener('input', (e) => {
  showThumbFor(e.currentTarget);
  markTouched('stress');
});
arousalSlider.addEventListener('input', (e) => {
  showThumbFor(e.currentTarget);
  markTouched('arousal');
});
pleasureSlider.addEventListener('input', (e) => {
  showThumbFor(e.currentTarget);
  markTouched('pleasure');
});

// 操作ログの表示/非表示を切り替える
toggleLogButton.onclick = function() {
  if (logContainer.style.display === "none" || logContainer.style.display === "") {
    logContainer.style.display = "block";
    toggleLogButton.src = "visibility_40dp_E8EAED_FILL0_wght400_GRAD0_opsz40.svg";
  } else {
    logContainer.style.display = "none";
    toggleLogButton.src = "visibility_off_40dp_E8EAED_FILL0_wght400_GRAD0_opsz40.svg";
  }
};

// ログのリセット
resetButton.onclick = function() {
  if (logEntries.length > 0) {
    const ok = confirm("ログをリセットしますか？\nReset the log?");
    if (!ok) return;
  }
  logEntries = [];       // ログ配列をクリア
  updateLogDisplay();    // 表示をクリア
  lastLogTimestamp = ''; // タイムスタンプをリセット
  touched = { stress: false, arousal: false, pleasure: false };
  firstInteractionAtMs = null;
  pulseElement(resetButton);
  hideThumbs();
  setSaveEnabled(false);
};

// ログのダウンロードボタン
downloadLogButton.onclick = function() {
  if (logEntries.length > 0) {
    exportLogToCSV();
    pulseElement(downloadLogButton);
  } else {
    alert("操作ログが空です。ログを追加してください。\nNo log entries found. Please add a log entry first.");
  }
};

// saveアイコンが押されたときにログを記録し、スライダーをリセット
submitButton.onclick = addLogEntry;

// Initial state: hide thumbs until the user interacts.
hideThumbs();
setSaveEnabled(false);

window.addEventListener('message', (event) => {
  if (!event.data || event.data.type !== 'affective-slider-export-csv') return;
  if (logEntries.length === 0) {
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ type: 'affective-slider-export-empty' }, '*');
    }
    return;
  }
  exportLogToCSV();
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'affective-slider-exported' }, '*');
  }
});

</script>

</body>
</html>
